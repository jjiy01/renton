<?xml version="1.0" encoding="UTF-8"?>
<bean:beans xmlns:bean="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns="http://www.springframework.org/schema/security"
    xmlns:oauth2="http://www.springframework.org/schema/security/oauth2"
    xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.2.xsd
        http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-4.2.xsd
        http://www.springframework.org/schema/security/oauth2 http://www.springframework.org/schema/security/spring-security-oauth2.xsd">

	<!-- <debug/> -->
	
	<http pattern="/lib/**" security="none" />
	<http pattern="/css/**" security="none" />
	<http pattern="/js/**" security="none" />
	
	<global-method-security proxy-target-class="true" pre-post-annotations="enabled" />
	
    <http pattern="/web/**"
    	auto-config="true" 
    	use-expressions="true" 
    	authentication-manager-ref="webAuthenticationManager"
    	
    	access-decision-manager-ref="affirmativeBased">
    	
    	<anonymous enabled="true"/>
    	<intercept-url pattern="/web/login" access="permitAll" />
    	<intercept-url pattern="/web/**" access="isAuthenticated()"/>
        
        <form-login 
        	login-page="/web/login"
        	username-parameter="userId"
        	password-parameter="password" 
        	login-processing-url="/web/doLogin" 
        	default-target-url="/web/main"/>
        	
        <logout logout-url="/web/doLogout" logout-success-url="/web/login" />

        <session-management session-fixation-protection="migrateSession">
        	<concurrency-control max-sessions="3" expired-url="/web/login" />
        </session-management>
        
        <custom-filter position="PRE_AUTH_FILTER" ref="preAuthenticationFilter"/>
    </http>
    
    <authentication-manager id="webAuthenticationManager">
        <authentication-provider user-service-ref="userDetailsService">
        	<!-- <password-encoder ref="passwordEncoder" /> -->
        </authentication-provider>
        
        <!-- <authentication-provider ref="rentonAuthenticationProvider" /> -->
    </authentication-manager>
    
    <authentication-manager id="preAuthenticationManager" >
    	<authentication-provider ref="preAuthenticationProvider"/>
    </authentication-manager>
    
    <bean:bean id="passwordEncoder" class="org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder"/>
    
    <bean:bean id="preAuthenticationFilter" class="com.jlab.renton.main.security.RentonPreAuthenticatedProcessingFilter">
    	<bean:property name="authenticationManager" ref="preAuthenticationManager"/>
    </bean:bean>
    
    <bean:bean id="preAuthenticationProvider" class="org.springframework.security.web.authentication.preauth.PreAuthenticatedAuthenticationProvider">
    	<bean:property name="preAuthenticatedUserDetailsService" ref="authUserDetailsService"/>
    </bean:bean>
    
    <bean:bean id="affirmativeBased" class="org.springframework.security.access.vote.AffirmativeBased">
    	<bean:constructor-arg>
    		<bean:list>
    			<!-- <bean:bean class="org.springframework.security.access.vote.RoleVoter"/> -->
    			<!-- <bean:bean class="org.springframework.security.access.vote.AuthenticatedVoter"/> -->
    			<bean:bean class="org.springframework.security.web.access.expression.WebExpressionVoter" />
    			<!-- <bean:bean class="com.jlab.renton.security.RentonAccessDecisionVoter" /> -->
    		</bean:list>
    	</bean:constructor-arg>
    </bean:bean>
</bean:beans>
